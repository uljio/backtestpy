//@version=5
strategy("T09 Niche Cost Reversal", shorttitle="T09_NCR", overlay=true,
         initial_capital=1000000, default_qty_type=strategy.cash,
         commission_type=strategy.commission.percent, commission_value=0.2)

// ğŸŒ™ Parameters
ema_period = input.int(20, "EMA Period", minval=1)
rsi_period = input.int(14, "RSI Period", minval=1)
std_period = input.int(20, "StdDev Period", minval=1)
vol_period = input.int(10, "Volume Period", minval=1)
rsi_oversold = input.int(30, "RSI Oversold", minval=1, maxval=50)
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=100)
std_mult = input.float(2.0, "StdDev Multiplier", minval=0.5, step=0.5)
stop_loss_pct = input.float(0.04, "Stop Loss %", minval=0.01, step=0.01)
profit_target = input.float(0.075, "Profit Target %", minval=0.01, step=0.01)
risk_per_trade = input.float(0.01, "Risk Per Trade %", minval=0.001, step=0.001)
max_hold_bars = input.int(480, "Max Hold Bars (5d on 15m)", minval=1)

// ğŸŒ™ Indicators
ema = ta.ema(close, ema_period)
rsi = ta.rsi(close, rsi_period)
std = ta.stdev(close, std_period)
vol_avg = ta.sma(volume, vol_period)

// Bollinger-style bands
lower_band = ema - std_mult * std
upper_band = ema + std_mult * std

// State variables
var int trade_bars = 0
var float entry_price = na

// ğŸŒ™ Entry Logic (Long Only - Mean Reversion)
entry_condition = close < lower_band and rsi < rsi_oversold and volume > vol_avg

if entry_condition and strategy.position_size == 0
    // Risk-based position sizing
    sl_price = close * (1 - stop_loss_pct)
    tp_price = close * (1 + profit_target)

    risk_amount = strategy.equity * risk_per_trade
    risk_per_unit = close - sl_price
    position_size = risk_amount / risk_per_unit

    if position_size > 0
        strategy.entry("Long", strategy.long, qty=position_size)
        strategy.exit("Exit Long", "Long", stop=sl_price, limit=tp_price)
        entry_price := close
        trade_bars := 0
        label.new(bar_index, low, "ğŸŒ™ LONG\n" + str.tostring(close, "#.##"),
                  style=label.style_label_up, color=color.green, textcolor=color.white)

// ğŸŒ™ Exit Logic
if strategy.position_size > 0
    trade_bars := trade_bars + 1

    // Reversion to mean
    if close >= ema
        strategy.close("Long", comment="Mean Revert âœ¨")
        label.new(bar_index, high, "âœ¨ Revert",
                  style=label.style_label_down, color=color.blue, textcolor=color.white)
        trade_bars := 0

    // Overbought exit
    else if rsi > rsi_overbought
        strategy.close("Long", comment="Overbought ğŸ“ˆ")
        label.new(bar_index, high, "ğŸ“ˆ OB",
                  style=label.style_label_down, color=color.purple, textcolor=color.white)
        trade_bars := 0

    // Time-based exit
    else if trade_bars > max_hold_bars
        strategy.close("Long", comment="Time Exit â°")
        label.new(bar_index, high, "â° Time",
                  style=label.style_label_down, color=color.orange, textcolor=color.white)
        trade_bars := 0
else
    trade_bars := 0

// ğŸŒ™ Plot indicators
plot(ema, "EMA", color=color.yellow, linewidth=2)
plot(lower_band, "Lower Band", color=color.red, linewidth=1)
plot(upper_band, "Upper Band", color=color.green, linewidth=1)

// ğŸŒ™ Moon Dev's Niche Cost Reversal Strategy
// Bollinger-style mean reversion with RSI confluence
